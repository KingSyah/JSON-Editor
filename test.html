<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test JSON Editor | © KingSyah</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>🧪 JSON Editor Test Suite</h1>
    <p style="text-align: center; color: #6c757d; margin-bottom: 30px;">
        <small>© 2025 KingSyah - Test Suite for JSON Editor v2.0</small>
    </p>
    
    <div class="test-card">
        <h2>📋 Pre-flight Checks</h2>
        <div id="preflightResults"></div>
        <button onclick="runPreflightChecks()">Run Preflight Checks</button>
    </div>

    <div class="test-card">
        <h2>📁 File Structure Test</h2>
        <div id="fileStructureResults"></div>
        <button onclick="testFileStructure()">Test File Structure</button>
    </div>

    <div class="test-card">
        <h2>🔧 JSON Validation Test</h2>
        <div id="jsonValidationResults"></div>
        <button onclick="testJSONValidation()">Test JSON Files</button>
    </div>

    <div class="test-card">
        <h2>🌐 Server Connectivity Test</h2>
        <div id="serverResults"></div>
        <button onclick="testServerConnectivity()">Test Server</button>
    </div>

    <div class="test-card">
        <h2>⚡ Performance Test</h2>
        <div id="performanceResults"></div>
        <button onclick="testPerformance()">Test Performance</button>
    </div>

    <div class="test-card">
        <h2>📊 Test Summary</h2>
        <div id="summaryResults"></div>
        <button onclick="runAllTests()">🚀 Run All Tests</button>
    </div>

    <script>
        let testResults = {
            preflight: false,
            fileStructure: false,
            jsonValidation: false,
            serverConnectivity: false,
            performance: false
        };

        function showResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function runPreflightChecks() {
            clearResults('preflightResults');
            
            // Check if running in browser
            if (typeof window !== 'undefined') {
                showResult('preflightResults', 'success', '✅ Running in browser environment');
            } else {
                showResult('preflightResults', 'error', '❌ Not running in browser');
                return;
            }

            // Check for required APIs
            if (typeof fetch !== 'undefined') {
                showResult('preflightResults', 'success', '✅ Fetch API available');
            } else {
                showResult('preflightResults', 'error', '❌ Fetch API not available');
            }

            if (typeof localStorage !== 'undefined') {
                showResult('preflightResults', 'success', '✅ LocalStorage available');
            } else {
                showResult('preflightResults', 'error', '❌ LocalStorage not available');
            }

            // Check for Bootstrap
            if (typeof bootstrap !== 'undefined') {
                showResult('preflightResults', 'success', '✅ Bootstrap loaded');
            } else {
                showResult('preflightResults', 'info', '⚠️ Bootstrap not loaded (normal for test page)');
            }

            testResults.preflight = true;
            showResult('preflightResults', 'success', '🎉 Preflight checks completed');
        }

        async function testFileStructure() {
            clearResults('fileStructureResults');
            
            const requiredFiles = [
                'index.html',
                'script.js',
                'config.js',
                'server.py',
                'run.bat',
                'run.sh'
            ];

            let filesFound = 0;
            
            for (const file of requiredFiles) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    if (response.ok) {
                        showResult('fileStructureResults', 'success', `✅ ${file} found`);
                        filesFound++;
                    } else {
                        showResult('fileStructureResults', 'error', `❌ ${file} not found`);
                    }
                } catch (error) {
                    showResult('fileStructureResults', 'error', `❌ ${file} error: ${error.message}`);
                }
            }

            if (filesFound === requiredFiles.length) {
                testResults.fileStructure = true;
                showResult('fileStructureResults', 'success', `🎉 All ${filesFound} files found`);
            } else {
                showResult('fileStructureResults', 'error', `❌ Only ${filesFound}/${requiredFiles.length} files found`);
            }
        }

        async function testJSONValidation() {
            clearResults('jsonValidationResults');

            // Test JSON validation with sample data
            try {
                const sampleData = {
                    source: "Test Data",
                    url: "",
                    extractedAt: new Date().toISOString(),
                    year: "2024",
                    tablesCount: 1,
                    tables: [{
                        tableIndex: 1,
                        headers: ["No", "Nama Penulis", "Judul", "Keterangan"],
                        rows: [
                            ["1", "Test Author", "Test Title", "Test Description"]
                        ]
                    }]
                };

                // Validate structure
                if (sampleData.tables && sampleData.tables[0] && sampleData.tables[0].rows) {
                    showResult('jsonValidationResults', 'success', '✅ JSON structure validation passed');
                    showResult('jsonValidationResults', 'info', `📊 Sample data contains ${sampleData.tables[0].rows.length} publication(s)`);
                    testResults.jsonValidation = true;
                    showResult('jsonValidationResults', 'success', '🎉 JSON validation test completed');
                } else {
                    showResult('jsonValidationResults', 'error', '❌ JSON structure validation failed');
                }
            } catch (error) {
                showResult('jsonValidationResults', 'error', `❌ JSON validation error: ${error.message}`);
            }
        }

        async function testServerConnectivity() {
            clearResults('serverResults');
            
            try {
                const response = await fetch('/');
                if (response.ok) {
                    showResult('serverResults', 'success', '✅ Server responding');
                    
                    // Test API endpoint
                    try {
                        const apiResponse = await fetch('/api/save', {
                            method: 'OPTIONS'
                        });
                        showResult('serverResults', 'success', '✅ API endpoint accessible');
                    } catch (error) {
                        showResult('serverResults', 'info', '⚠️ API endpoint test failed (normal if server not running)');
                    }
                    
                    testResults.serverConnectivity = true;
                } else {
                    showResult('serverResults', 'error', '❌ Server not responding properly');
                }
            } catch (error) {
                showResult('serverResults', 'error', `❌ Server connection error: ${error.message}`);
            }
        }

        async function testPerformance() {
            clearResults('performanceResults');

            const startTime = performance.now();

            try {
                // Test JSON processing speed
                const sampleData = {
                    source: "Performance Test",
                    tables: [{
                        headers: ["No", "Nama Penulis", "Judul", "Keterangan"],
                        rows: Array.from({length: 100}, (_, i) => [
                            String(i + 1),
                            `Author ${i + 1}`,
                            `Title ${i + 1}`,
                            `Description ${i + 1}`
                        ])
                    }]
                };

                const processTime = performance.now() - startTime;

                if (processTime < 100) {
                    showResult('performanceResults', 'success', `✅ JSON processed in ${processTime.toFixed(2)}ms`);
                } else {
                    showResult('performanceResults', 'info', `⚠️ JSON processed in ${processTime.toFixed(2)}ms (slow)`);
                }

                // Test memory usage
                const jsonSize = JSON.stringify(sampleData).length;
                showResult('performanceResults', 'info', `📊 Sample JSON size: ${(jsonSize / 1024).toFixed(2)} KB`);
                showResult('performanceResults', 'info', `📊 Sample contains: ${sampleData.tables[0].rows.length} publications`);

                testResults.performance = true;
                showResult('performanceResults', 'success', '🎉 Performance test completed');

            } catch (error) {
                showResult('performanceResults', 'error', `❌ Performance test failed: ${error.message}`);
            }
        }

        async function runAllTests() {
            clearResults('summaryResults');
            showResult('summaryResults', 'info', '🚀 Running all tests...');
            
            await runPreflightChecks();
            await testFileStructure();
            await testJSONValidation();
            await testServerConnectivity();
            await testPerformance();
            
            // Generate summary
            const passedTests = Object.values(testResults).filter(result => result).length;
            const totalTests = Object.keys(testResults).length;
            
            if (passedTests === totalTests) {
                showResult('summaryResults', 'success', `🎉 All tests passed! (${passedTests}/${totalTests})`);
                showResult('summaryResults', 'success', '✅ JSON Editor is ready to use!');
            } else {
                showResult('summaryResults', 'error', `❌ ${passedTests}/${totalTests} tests passed`);
                showResult('summaryResults', 'info', '💡 Check individual test results above');
            }
        }

        // Auto-run preflight checks on load
        window.addEventListener('load', () => {
            setTimeout(runPreflightChecks, 500);
        });
    </script>
</body>
</html>
